# 聊吧论坛后端接口规范

用户注册需要邀请码，当以`master@talkforum.top`为用户名注册成功时，将成为管理员且不需要邀请码

## 一、返回值标准结构

不设置返回请求码，除了权限不够的情况除外（401， 403），通过success判断是否成功，code为返回代码

返回的时间格式为UTC字符串，用dayjs解析即可获得时间

```java
public class Result{
    private Integer code;    // 对标HTTP响应返回码
    private Boolean success; // 操作是否成功
    private String message;  // 操作反馈信息
    private Object data;     // 操作返回数据
}
```

## 二、接口规范

接口总览，其中分页大小全局约束为最大为10，分页有游标分页和传统分页两种

| 接口前缀         | 对应表                             | 核心场景                   | 权限                                          |
| ---------------- | ---------------------------------- | -------------------------- | --------------------------------------------- |
| `/auth`          | auth_token                         | 登录/登出                  | 登录无Token，登出需登录态                     |
| `/users`         | users                              | 用户注册/信息管理          | 普通操作需登录，管理员带/admin                |
| `/posts`         | post                               | 帖子管理                   | 普通操作需登录，权限操作带/admin              |
| `/clubs`         | club                               | 圈子管理                   | 普通操作需登录，权限操作带/admin              |
| `/comments`      | comment                            | 评论管理                   | 普通操作需登录，权限操作带/admin              |
| `/applies`       | club_apply_create、club_apply_join | 圈子申请                   | 申请需登录，审核需权限                        |
| `/notifications` | notification                       | 通知管理                   | 仅操作自己的通知                              |
| `/reports`       | report                             | 举报提交/处理/查询         | 提交需登录，处理需管理员/风纪，查询仅本人举报 |
| `/interactions`  | interaction                        | 点赞/踩/关注操作及记录查询 | 仅登录用户操作本人互动，查询本人互动记录      |

### 1. 认证接口（/auth）finished

此接口规定了如何登录，登出，获得登录信息，判断权限等

| 路径           | 方法 | 入参                                               | 出参                                                         | 权限               | 表操作                       |
| -------------- | ---- | -------------------------------------------------- | ------------------------------------------------------------ | ------------------ | ---------------------------- |
| `/auth/login`  | POST | email（登录邮箱）、password（密码）                | token（登录令牌）、expireTime（过期时间）、userInfo（id/name/role） | 无需登录           | 生成JWT令牌，设置Cookie      |
| `/auth/logout` | POST | 无（Token放Cookie：talkforum-token）                | code:200、message:"Sign out successfully"                     | 需登录             | 清除登录Cookie               |
| `/auth/`       | GET  | 无（Token放Cookie：talkforum-token）                | userInfo（id/name/role等）                                    | 需登录             | 验证登录状态，更新Token      |
| `/auth/admin`  | GET  | 无（Token放Cookie：talkforum-token）                | userInfo（id/name/role等）                                    | 需风纪或管理员身份 | 验证管理员权限，更新Token    |

### 2. 用户接口（/users）

此接口定义了用户可以如何注册，修改个人信息，查询个人信息，修改密码，管理员可以修改用户的身份(role)，重置用户的密码，禁用或者取消禁用

用户身份ROLE 普通用户USER 管理员ADMIN 风纪MODERATOR，风纪仅有部分管理员权限，已被规定好

~~同一 IP 短时间内注册次数限制~~（太难了，以后再说）

#### 2.1 普通用户操作 finished

| 路径                    | 方法 | 入参                                                         | 出参                                           | 权限     | 表操作               |
| ----------------------- | ---- | ------------------------------------------------------------ | ---------------------------------------------- | -------- | -------------------- |
| `/users`                | POST | email（唯一）、password（密码）、name（用户名）、inviteCode（邀请码） | code:200、userInfo（完整用户信息）             | 无需登录 | 插入user（新建用户） |
| `/users/{userId}`       | GET  | 无                                                          | userInfo（id/name/intro/email等）              | 无需登录 | 查询user（用户信息） |
| `/users/simple`         | GET  | userIds（数组参数）                                          | [avatarLink, name等简化信息]                   | 无需登录 | 查询一些人的简单信息 |
| `/users/`               | PUT  | name（可选）、intro（可选）等用户资料信息                    | code:200、message:"修改成功"                   | 需登录   | 更新user（本人信息） |
| `/users/changePassword` | PUT  | oldPassword newPassword                                      | code:200、message:"修改成功"                   | 需登录   | 更新user（密码信息） |

#### 2.2 管理员操作 finished

| 路径                           | 方法 | 入参                                                     | 出参                                 | 权限        | 表操作               |
| ------------------------------ | ---- | -------------------------------------------------------- | ------------------------------------ | ----------- | -------------------- |
| `/users/admin`                 | GET  | page（页码）、pageSize（每页大小）                       | total（总数）、data（用户列表）      | 风纪/管理员 | 获取所有用户列表     |
| `/users/admin/{userId}/role`   | PUT  | role（ADMIN/MODERATOR，直接传字符串字面量）              | code:200、message:"修改角色成功"     | 管理员      | 更新user（用户角色） |
| `/users/admin/{userId}/status` | PUT  | status（NORMAL/UNABLE，直接传字符串字面量）              | code:200、message:"修改用户状态成功" | 风纪/管理员 | 更新user（用户状态） |
| `/users/admin/{userId}/reset`  | PUT  | 无                                                       | code:200、message:"密码重置成功"     | 管理员      | 更新user（密码哈希） |

### 3. 帖子接口（/posts）

此接口定义用户如何发帖，修改帖子内容，获取帖子列表，删掉帖子（软删掉），管理员审核帖子，管理员或者风纪给帖子加精。帖子状态有status（PENDING/PASS/REJECT/DELETE）

#### 3.1 帖子操作 finished

| 路径              | 方法   | 入参                                                         | 出参                                                | 权限                                                         | 表操作               |
| ----------------- | ------ | ------------------------------------------------------------ | --------------------------------------------------- | ------------------------------------------------------------ | -------------------- |
| `/posts`          | POST   | title（标题）、content（内容）、clubId（可选，圈子ID）       | code:200、postInfo（完整帖子信息）                   | 需登录                                                       | 插入post（新建帖子） |
| `/posts`          | GET    | keyword（可选）、cursor（游标）、pageSize（每页大小）、clubId（可选）、userId（可选）、isEssence（可选） 游标分页形式 | {data（列表）, 分页信息}                             | 无（公开帖列表）                                             | 查询post（帖子列表） |
| `/posts/{postId}` | GET    | 无                                                           | postInfo（标题/内容/作者/浏览量等完整信息）          | 无（公开帖）                                                 | 查询post（帖子详情） |
| `/posts/{postId}` | PUT    | title（可选）、content（可选）等帖子内容                     | code:200、message:"修改成功"                        | 需登录（本人）                                               | 更新post（本人帖子） |
| `/posts/{postId}` | DELETE | 无                                                           | code:200、message:"删除成功"                        | 需登录（本人）                                               | 更新post（标记删除） |

#### 3.2 帖子权限操作（管理员/风纪）finished

| 路径                            | 方法 | 入参                                                         | 出参                         | 权限        | 表操作               |
| ------------------------------- | ---- | ------------------------------------------------------------ | ---------------------------- | ----------- | -------------------- |
| `/posts/admin`                  | GET  | keyword（可选）、page（页码）、pageSize（每页大小）、clubId（可选）、userIds（可选）、isEssence（可选）、status（帖子状态，可选） | {total, data（帖子列表）}    | 管理员/风纪 | 查询post列表         |
| `/posts/admin/{postId}/audit`   | PUT  | status（PASS/REJECT/DELETE，直接传字符串字面量）             | code:200、message:"审核成功" | 管理员/风纪 | 更新post（帖子状态） |
| `/posts/admin/{postId}/essence` | PUT  | isEssence（布尔值，true/false）                               | code:200、message:"操作成功" | 管理员/风纪 | 更新post（精华状态） |

### 4. 圈子接口（/clubs）

此接口定义了用户如何查看圈子列表，查看圈子详情，修改圈子信息，解散圈子，以及邀请/移除成员

| 路径                      | 方法   | 入参                                   | 出参                             | 权限                    | 表操作               |
| ------------------------- | ------ | -------------------------------------- | -------------------------------- | ----------------------- | -------------------- |
| `/clubs/`                 | GET    | page（页码）、count（每页数量）        | 圈子列表数据                     | 无                      | 查询club（圈子列表） |
| `/clubs/{clubId}`         | GET    | 无                                     | clubInfo（名称/描述/成员数等）   | 无                      | 查询club（圈子详情） |
| `/clubs/{clubId}/members/`| POST   | userId（用户ID）                       | code:200、message:"success to send the invitation!" | 需登录 | 邀请成员加入圈子 |
| `/clubs/{clubId}/members/{userId}` | DELETE | 无                       | code:200、message:"success to remove the member!" | 需登录 | 移除圈子成员 |
| `/clubs/{clubId}`         | PUT    | ClubProfileDTO（包含更新信息）         | code:200、message:"success to update the club!" | 需登录（创建者/管理员） | 更新club（圈子信息） |
| `/clubs/{clubId}`         | DELETE | 无                                     | code:200、message:"success to delete the club!" | 需登录（创建者/管理员） | 删除club（圈子数据） |

### 5. 评论接口（/comments）

此接口定义了用户如何评论帖子，评论帖子下方的评论，管理员审核评论（不允许修改帖子内容，删掉是软删掉）

#### 5.1 用户操作  finished

| 路径                    | 方法   | 入参                                                         | 出参                          | 权限                           | 表操作                      |
| ----------------------- | ------ | ------------------------------------------------------------ | ----------------------------- | ------------------------------ | --------------------------- |
| `/comments`             | POST   | postId（帖子ID）、content（内容）、rootId（可空）、parentId（可空） | code:200、comment（完整评论信息） | 需登录                         | 插入comment（新建评论）     |
| `/comments`             | GET    | postId（必填，帖子ID）、cursor（可选，游标分页）、pageSize（必填，每页大小） | comments（评论列表）         | 无                             | 查询comment（评论列表）     |
| `/comments/replies`     | GET    | postId（必填，帖子ID）、cursor（可选，游标分页）、pageSize（必填，每页大小）、rootId（必填，根评论ID）、parentId（可选，父节点ID） | comments（评论回复列表）     | 无                             | 查询comment（评论列表）     |
| `/comments/{commentId}` | DELETE | 无                                                           | code:200、message:"删除成功"  | 需登录（本人/MODERATOR/ADMIN） | 更新comment（is_deleted=1） |

#### 5.2 管理员操作 fnished

| 路径                    | 方法 | 入参                                                         | 出参                         | 权限        | 表操作                  |
| ----------------------- | ---- | ------------------------------------------------------------ | ---------------------------- | ----------- | ----------------------- |
| `/comments/admin`       | GET  | page（页码）、pageSize（每页大小）、status（可选，评论状态）等筛选参数 | code:200、{total, data}       | 管理员/风纪 | 查询comment列表        |
| `/comments/admin/audit` | PUT  | status（PASS/REJECT/DELETE，直接传字符串字面量） commentIds涉及的所有评论id | code:200、message:"审核完成" | 管理员/风纪 | 更新comment（评论状态） |

### 6. 圈子申请接口（/applies）

此接口定义了用户如何申请创建圈子，发送加入圈子请求，管理员或者圈子主如何处理申请信息

#### 6.1 创建申请

| 路径                              | 方法 | 入参                                                         | 出参                         | 权限        | 表操作                            |
| --------------------------------- | ---- | ------------------------------------------------------------ | ---------------------------- | ----------- | --------------------------------- |
| `/applies/create`                 | POST | name（圈子名称）、description（圈子描述）                    | code:200、applyId（申请ID）  | 需登录      | 插入club_apply_create（新建申请） |
| `/applies/create/admin/{applyId}` | PUT  | status（PASS/REJECT，直接传字符串字面量，即上面的内容）、handledBy（处理人ID） | code:200、message:"审核完成" | 管理员/风纪 | 更新club_apply_create（申请状态） |

#### 6.2 加入申请

| 路径                      | 方法 | 入参                                                         | 出参                         | 权限               | 表操作                          |
| ------------------------- | ---- | ------------------------------------------------------------ | ---------------------------- | ------------------ | ------------------------------- |
| `/applies/join/{clubId}`  | POST | 无                                                           | code:200、applyId（申请ID）  | 需登录             | 插入club_apply_join（新建申请） |
| `/applies/join/{applyId}` | PUT  | status（PASS/REJECT，直接传字符串字面量，即上面的内容）、handledBy（处理人ID） | code:200、message:"审核完成" | 圈子创建者，需登录 | 更新club_apply_join（申请状态） |

#### 6.3 查询申请

| 路径                      | 方法 | 入参                                            | 出参                        | 权限   | 表操作                                   |
| ------------------------- | ---- | ----------------------------------------------- | --------------------------- | ------ | ---------------------------------------- |
| `/applies/admin/{clubId}` | GET  | page（页码）pageSize（大小），type(JOIN/CREATE) | code:200、applyId（申请ID） | 需登录 | 查询club_apply_join或者club_apply_create |

### 7. 通知接口（/notifications）

此接口定义了用户收到通知的内容，如管理员删掉帖子，举报消息成功发送，圈子主收到申请，用户的帖子审核通过，用户被关注，用户被点赞等等可能产生通知的情形

| 路径              | 方法   | 入参                                                         | 出参                                    | 权限           | 表操作                           |
| ----------------- | ------ | ------------------------------------------------------------ | --------------------------------------- | -------------- | -------------------------------- |
| `/notifications/` | GET    | pageCursor（游标分页）、pageSize、isRead（可选，0=未读/1=已读） | notifications（列表），具体等待后端定义 | 需登录         | 查询notification（通知列表）     |
| `/notifications/` | PUT    | notifyIds涉及的所有通知id                                    | code:200、message:"标记已读成功"        | 需登录（本人） | 更新notification（is_read=1）    |
| `/notifications/` | DELETE | notifyIds涉及的所有通知id                                    | code:200、message:"删除成功"            | 需登录（本人） | 更新notification（is_deleted=1） |

### 8. 举报接口（/reports）

此接口定义了用户如何举报帖子，用户，圈子。举报类型（）被举报的对象类型（COMMENT=评论/POST=帖子/USER=用户，直接传字符串字面量）被举报的对象ID（如帖子ID/评论ID/用户ID）

#### 8.1 普通用户操作  finished

| 路径        | 方法 | 入参                                                         | 出参                                                 | 权限   | 表操作                                               |
| ----------- | ---- | ------------------------------------------------------------ | ---------------------------------------------------- | ------ | ---------------------------------------------------- |
| `/reports/` | POST | reportType（举报类型）、reportTargetType（被举报对象类型）、reportTarget（被举报对象ID）、reason（举报理由，可选） | code:200、message:"Success to report it! Please wait for the administrators to check!" | 需登录 | 插入report（新建举报记录），发送“新举报通知”给管理员 |

#### 8.2 管理员/风纪操作 finished

| 路径             | 方法 | 入参                                                         | 出参                                   | 权限        | 表操作                                                       |
| ---------------- | ---- | ------------------------------------------------------------ | -------------------------------------- | ----------- | ------------------------------------------------------------ |
| `/reports/admin` | GET  | page（页码）、pageSize（页面大小）、reportTargetType（可选）、status（可选） | 举报列表数据 | 管理员/风纪 | 查询report（全量举报记录）                                   |
| `/reports/admin` | POST  | status（处理状态）、reportIds（涉及的所有举报内容）          | code:200、message:"Success to handle reports!"       | 管理员/风纪 | 更新report（处理状态+处理人+处理时间）；若status=PROCESSED，联动处理被举报对象（如帖子/评论置为REJECT），发送“举报处理结果通知”给举报人 |

### 9. 互动接口（/interactions）

此接口用于记录用户对帖子、评论、用户的点赞/踩操作，以及对用户的关注操作。

**约束说明**：
- 同一用户对同一对象的互动操作需限制频率（1分钟内最多5次）
- 互动类型 `interactType` 枚举值：POST（帖子）、USER（用户）、COMMENT（评论）
- 互动内容 `interactContent` 取值说明：
  - 对于 POST/COMMENT 类型：-1（踩）、0（无互动）、1（赞）
  - 对于 USER 类型：0（未关注）、1（已关注）

#### 9.1 互动操作（点赞/踩/关注）finished

| 路径            | 方法 | 入参                                                         | 出参                        | 权限   | 表操作                                  |
| --------------- | ---- | ------------------------------------------------------------ | --------------------------- | ------ | --------------------------------------- |
| `/interactions` | POST | interactType（互动类型）、interactId（被互动对象ID）、interactContent（互动状况） | code:200、message:"success" | 需登录 | 若记录存在则更新互动内容，否则创建新记录 |

#### 9.2 互动记录查询（暂不实现）

| 路径                      | 方法 | 入参 | 出参                | 权限   | 表操作                         |
| ------------------------- | ---- | ---- | ------------------- | ------ | ------------------------------ |
| `/interactions/following` | GET  | 无   | userIds所有关注的人 | 需登录 | 查询本人互动记录，根据条件筛选 |
| `/interactions/followers` | GET  | 无   |                     |        |                                |

### 10. 邀请码接口（/invitecode）

#### 10.1 用户操作 finished

| 路径                | 方法 | 入参   | 出参                                   | 权限   | 表操作               |
| ------------------- | ---- | ------ | -------------------------------------- | ------ | -------------------- |
| `/invitecode/`  | GET  | 无（Token放Cookie）     | code:200、inviteCodes:[邀请码列表] | 需登录 | 查询用户的邀请码列表 |

#### 10.2 管理员操作 finished

| 路径                   | 方法 | 入参                                                         | 出参                                 | 权限    | 表操作               |
| ---------------------- | ---- | ------------------------------------------------------------ | ------------------------------------ | ------- | -------------------- |
| `/invitecode/admin` | GET  | page（页码）、pageSize（每页大小）                       | total InviteCode[] data | 管理员 | 查询所有邀请码列表   |
| `/invitecode/admin` | POST | count（生成数量）、expiredDays（过期时间）、maxCount（最大使用次数） | InviteCode[] data | 管理员 | 生成新邀请码         |
| `/invitecode/admin/` | PUT | maxCount (最多使用次数）, expiredDays（过期次数） | code:200 message:success | 管理员 | 修改邀请码使用时间或者过期时间 |
| `/invitecode/admin/` | DELETE | codes 邀请码列表                                 | code:200、message:"删除成功"          | 管理员 | 删除邀请码           |

