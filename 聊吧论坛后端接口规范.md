# 聊吧论坛后端接口规范

用户注册需要邀请码，当以`master@talkforum.top`为用户名注册成功时，将成为管理员且不需要邀请码

## 一、返回值标准结构

不设置返回请求码，除了权限不够的情况除外（401， 403），通过success判断是否成功，code为返回代码

返回的时间格式为UTC字符串，用dayjs解析即可获得时间

```java
public class Result{
    private Integer code;    // 对标HTTP响应返回码
    private Boolean success; // 操作是否成功
    private String message;  // 操作反馈信息
    private Object data;     // 操作返回数据
}
```

## 二、接口规范

接口总览，其中分页大小全局约束为最大为10，分页有游标分页和传统分页两种

| 接口前缀         | 对应表                             | 核心场景                   | 权限                                          |
| ---------------- | ---------------------------------- | -------------------------- | --------------------------------------------- |
| `/auth`          | auth_token                         | 登录/登出                  | 登录无Token，登出需登录态                     |
| `/users`         | users                              | 用户注册/信息管理          | 普通操作需登录，管理员带/admin                |
| `/posts`         | post                               | 帖子管理                   | 普通操作需登录，权限操作带/admin              |
| `/clubs`         | club                               | 圈子管理                   | 普通操作需登录，权限操作带/admin              |
| `/comments`      | comment                            | 评论管理                   | 普通操作需登录，权限操作带/admin              |
| `/applies`       | club_apply_create、club_apply_join | 圈子申请                   | 申请需登录，审核需权限                        |
| `/notifications` | notification                       | 通知管理                   | 仅操作自己的通知                              |
| `/reports`       | report                             | 举报提交/处理/查询         | 提交需登录，处理需管理员/风纪，查询仅本人举报 |
| `/interactions`  | interaction                        | 点赞/踩/关注操作及记录查询 | 仅登录用户操作本人互动，查询本人互动记录      |

### 1. 认证接口（/auth）finished

此接口规定了如何登录，登出，获得登录信息，判断权限等

| 路径           | 方法 | 入参                                               | 出参                                                         | 权限               | 表操作                       |
| -------------- | ---- | -------------------------------------------------- | ------------------------------------------------------------ | ------------------ | ---------------------------- |
| `/auth/login`  | POST | email（登录邮箱）、password（密码）                | token（登录令牌）、expireTime（过期时间）、userInfo（id/name/role） | 无需登录           | 插入auth_token（生成令牌）   |
| `/auth/logout` | POST | 无（Token放请求头：Authorization: Bearer {token}） | code:200、message:"登出成功"                                 | 需登录             | 更新auth_token（is_valid=0） |
| `/auth/`       | GET  | 无                                                 | code message userinfo                                        | 需登录             | 读                           |
| `/auth/admin`  | GET  | 无                                                 | code message userinfo                                        | 需风纪或管理员身份 | 读                           |

### 2. 用户接口（/user）

此接口定义了用户可以如何注册，修改个人信息，查询个人信息，修改密码，管理员可以修改用户的身份(role)，重置用户的密码，禁用或者取消禁用

用户身份ROLE 普通用户USER 管理员ADMIN 风纪MODERATOR，风纪仅有部分管理员权限，已被规定好

~~同一 IP 短时间内注册次数限制~~（太难了，以后再说）

#### 2.1 普通用户操作 finished

| 路径                    | 方法 | 入参                                                         | 出参                                           | 权限     | 表操作               |
| ----------------------- | ---- | ------------------------------------------------------------ | ---------------------------------------------- | -------- | -------------------- |
| `/users`                | POST | email（唯一）、password（密码）、name（用户名）、inviteCode（邀请码） | code:200、message:"注册成功"、userId（用户ID） | 无需登录 | 插入user（新建用户） |
| `/users/{userId}`       | GET  | 无（Token放请求头）                                          | userInfo（id/name/intro/email等）              | 需登录   | 查询user（本人信息） |
| `/users/simple`         | GET  | userIds                                                      | [avatarLink, name]                             | 需登录   | 查询一些人的简单信息 |
| `/users/`               | PUT  | name（可选）、intro（可选）                                  | code:200、message:"修改成功"                   | 需登录   | 更新user（本人信息） |
| `/users/changePassword` | PUT  | oldPassword newPassword                                      | code                                           | 需登录   | 更新user（本人信息） |

#### 2.2 管理员操作 finished

| 路径                           | 方法 | 入参                                   | 出参                                 | 权限        | 表操作               |
| ------------------------------ | ---- | -------------------------------------- | ------------------------------------ | ----------- | -------------------- |
| `/users/admin/`                | GET  | page（页码）、pageSize（数目，最大10） | users                                | 风纪/管理员 | 获取所有用户列表     |
| `/users/admin/{userId}/role`   | PUT  | role（USER/MODERATOR）                 | code:200、message:"角色修改成功"     | 管理员      | 更新user（用户角色） |
| `/users/admin/{userId}/status` | PUT  | status(NORMAL/UNABLE)                  | code:200、message:"修改用户状态成功" | 管理员      | 更新user（用户数据） |
| `/users/admin/{userId}/reset`  | PUT  | password（新密码）                     | code:200、message:"密码重置成功"     | 风纪/管理员 | 更新user（密码哈希） |

### 3. 帖子接口（/posts）

此接口定义用户如何发帖，修改帖子内容，获取帖子列表，删掉帖子（软删掉），管理员审核帖子，管理员或者风纪给帖子加精。帖子状态有status（PENDING/PASS/REJECT/DELETE）

#### 3.1 帖子操作 finished

| 路径              | 方法   | 入参                                                         | 出参                                                | 权限                                                         | 表操作               |
| ----------------- | ------ | ------------------------------------------------------------ | --------------------------------------------------- | ------------------------------------------------------------ | -------------------- |
| `/posts`          | POST   | title（标题）、content（内容）、clubId（可选，圈子ID）       | code:200、postId（帖子ID）                          | 需登录                                                       | 插入post（新建帖子） |
| `/posts`          | GET    | keyword（可选，关键词）、cursor（页码）、pageSize（数目，最大10）、clubId[]（可选）、userId[]（可选）、isEssence（可选）    游标分页形式 | {data（列表）,hasMore, cursor游标}                  | 无（筛选精选帖子，关注的人的帖子，某个圈子的帖子都是用这个接口） | 查询post（帖子列表） |
| `/posts/{postId}` | GET    | 无                                                           | postInfo（标题/内容/作者/浏览量等），详细由后端决定 | 无（公开帖）                                                 | 查询post（帖子详情） |
| `/posts/{postId}` | PUT    | title（可选）、content（可选）                               | code:200、message:"修改成功"                        | 需登录（本人）                                               | 更新post（本人帖子） |
| `/posts/{postId}` | DELETE | 无                                                           | code:200、message:"删除成功"                        | 需登录（本人）                                               | 更新post（标记删除） |

#### 3.2 帖子权限操作（管理员/风纪）finished

| 路径                            | 方法 | 入参                                                         | 出参                         | 权限        | 表操作               |
| ------------------------------- | ---- | ------------------------------------------------------------ | ---------------------------- | ----------- | -------------------- |
| `/posts/admin/`                 | GET  | keyword（可选，关键词）、page（页码）、pageSize（数目，最大10）、clubId []（可选）、userIds []（可选）、isEssence（可选）status（帖子状态） | posts（列表）                | 管理员/风纪 | 查询post列表         |
| `/posts/admin/{postId}/audit`   | PUT  | status（PASS/REJECT/DELETE）管理员删帖，通过，拒绝都是调用这个 | code:200、message            | 管理员/风纪 | 更新post（帖子状态） |
| `/posts/admin/{postId}/essence` | PUT  | isEssence（1=加精/0=取消）                                   | code:200、message:"操作成功" | 管理员/风纪 | 更新post（精华状态） |

### 4. 圈子接口（/clubs)

此接口定义查询和修改帖子信息的方式

| 路径              | 方法   | 入参                                   | 出参                             | 权限                    | 表操作               |
| ----------------- | ------ | -------------------------------------- | -------------------------------- | ----------------------- | -------------------- |
| `/clubs/`         | GET    | pageCursor（游标分页）pageSize（大小） | clubs（列表）、total（总数）     | 无                      | 查询club（圈子列表） |
| `/clubs/{clubId}` | GET    | 无                                     | clubInfo（名称/描述/成员数等）   | 无                      | 查询club（圈子详情） |
| `/clubs/{clubId}` | PUT    | name（可选）、description（可选）      | code:200、message:"修改成功"     | 需登录（创建者/管理员） | 更新club（圈子信息） |
| `/clubs/{clubId}` | DELETE | 无                                     | code:200、message:"圈子解散成功" | 需登录（创建者/管理员） | 删除club（圈子数据） |

### 5. 评论接口（/comments）

此接口定义了用户如何评论帖子，评论帖子下方的评论，管理员审核评论（不允许修改帖子内容，删掉是软删掉）

#### 5.1 用户操作  finished

| 路径                    | 方法   | 入参                                                         | 出参                          | 权限                           | 表操作                      |
| ----------------------- | ------ | ------------------------------------------------------------ | ----------------------------- | ------------------------------ | --------------------------- |
| `/comments`             | POST   | postId（帖子ID）、content（内容）、rootId（可空）、parentId（可空） | code:200、commentId（评论ID） | 需登录                         | 插入comment（新建评论）     |
| `/comments`             | GET    | postId（帖子ID）、cursor（游标分页）、pageSize               | comments（列表）              | 无                             | 查询comment（评论列表）     |
| `/comments/replies`     | GET    | postId（帖子ID）、cursor（游标分页）、pageSize、rootId根评论）id、parentId父节点id（可空） | comments（列表）              | 无                             | 查询comment（评论列表）     |
| `/comments/{commentId}` | DELETE | 无                                                           | code:200、message:"删除成功"  | 需登录（本人/MODERATOR/ADMIN） | 更新comment（is_deleted=1） |

#### 5.2 管理员操作 fnished

| 路径                    | 方法 | 入参                                                         | 出参                         | 权限        | 表操作                  |
| ----------------------- | ---- | ------------------------------------------------------------ | ---------------------------- | ----------- | ----------------------- |
| `/comments/admin/`      | GET  | status(可以不传)对应数据库的（PENDING/PASS/REJECT/DELETE）,page（页码）pageSize（大小）， | code:200                     | 管理员/风纪 | 查询comment             |
| `/comments/admin/audit` | PUT  | status（PASS/REJECT） commentIds涉及的所有评论id             | code:200、message:"审核完成" | 管理员/风纪 | 更新comment（评论状态） |

### 6. 圈子申请接口（/applies）

此接口定义了用户如何申请创建圈子，发送加入圈子请求，管理员或者圈子主如何处理申请信息

#### 6.1 创建申请

| 路径                              | 方法 | 入参                                         | 出参                         | 权限        | 表操作                            |
| --------------------------------- | ---- | -------------------------------------------- | ---------------------------- | ----------- | --------------------------------- |
| `/applies/create`                 | POST | name（圈子名称）、description（圈子描述）    | code:200、applyId（申请ID）  | 需登录      | 插入club_apply_create（新建申请） |
| `/applies/create/admin/{applyId}` | PUT  | status（PASS/REJECT）、handledBy（处理人ID） | code:200、message:"审核完成" | 管理员/风纪 | 更新club_apply_create（申请状态） |

#### 6.2 加入申请

| 路径                      | 方法 | 入参                                         | 出参                         | 权限               | 表操作                          |
| ------------------------- | ---- | -------------------------------------------- | ---------------------------- | ------------------ | ------------------------------- |
| `/applies/join/{clubId}`  | POST | 无                                           | code:200、applyId（申请ID）  | 需登录             | 插入club_apply_join（新建申请） |
| `/applies/join/{applyId}` | PUT  | status（PASS/REJECT）、handledBy（处理人ID） | code:200、message:"审核完成" | 圈子创建者，需登录 | 更新club_apply_join（申请状态） |

#### 6.3 查询申请

| 路径                      | 方法 | 入参                                            | 出参                        | 权限   | 表操作                                   |
| ------------------------- | ---- | ----------------------------------------------- | --------------------------- | ------ | ---------------------------------------- |
| `/applies/admin/{clubId}` | GET  | page（页码）pageSize（大小），type(JOIN/CREATE) | code:200、applyId（申请ID） | 需登录 | 查询club_apply_join或者club_apply_create |

### 7. 通知接口（/notifications）

此接口定义了用户收到通知的内容，如管理员删掉帖子，举报消息成功发送，圈子主收到申请，用户的帖子审核通过，用户被关注，用户被点赞等等可能产生通知的情形

| 路径              | 方法   | 入参                                                         | 出参                                    | 权限           | 表操作                           |
| ----------------- | ------ | ------------------------------------------------------------ | --------------------------------------- | -------------- | -------------------------------- |
| `/notifications/` | GET    | pageCursor（游标分页）、pageSize、isRead（可选，0=未读/1=已读） | notifications（列表），具体等待后端定义 | 需登录         | 查询notification（通知列表）     |
| `/notifications/` | PUT    | notifyIds涉及的所有通知id                                    | code:200、message:"标记已读成功"        | 需登录（本人） | 更新notification（is_read=1）    |
| `/notifications/` | DELETE | notifyIds涉及的所有通知id                                    | code:200、message:"删除成功"            | 需登录（本人） | 更新notification（is_deleted=1） |

### 8. 举报接口（/reports）

此接口定义了用户如何举报帖子，用户，圈子。举报类型（SPAM=垃圾信息/ILLEGAL=违法内容/OTHER=其他）被举报的对象类型（COMMENT=评论/POST=帖子/USER=用户）被举报的对象ID（如帖子ID/评论ID/用户ID）

#### 8.1 普通用户操作  finished

| 路径       | 方法 | 入参                                                         | 出参                                                 | 权限   | 表操作                                               |
| ---------- | ---- | ------------------------------------------------------------ | ---------------------------------------------------- | ------ | ---------------------------------------------------- |
| `/reports` | POST | report_type（举报类型）、report_target_type（被举报对象类型）、report_target（被举报对象ID）、reason（举报理由，可选） | code:200、message:"举报提交成功"、reportId（举报ID） | 需登录 | 插入report（新建举报记录），发送“新举报通知”给管理员 |

#### 8.2 管理员/风纪操作 finished

| 路径             | 方法 | 入参                                                         | 出参                                   | 权限        | 表操作                                                       |
| ---------------- | ---- | ------------------------------------------------------------ | -------------------------------------- | ----------- | ------------------------------------------------------------ |
| `/reports/admin` | GET  | page（页码）、pageSize(页面大小)、status（可选）、report_target_type（ 举报类型 可选） | reports（全量举报列表）、total（总数） | 管理员/风纪 | 查询report（全量举报记录）                                   |
| `/reports/admin` | PUT  | status（处理状态）、reportIds（涉及的所有举报内容）          | code:200、message:"举报处理完成"       | 管理员/风纪 | 更新report（处理状态+处理人+处理时间）；若status=PROCESSED，联动处理被举报对象（如帖子/评论置为REJECT），发送“举报处理结果通知”给举报人 |

### 9. 互动接口（/interactions）

此接口用于记录用户对其他人的点赞，踩，关注的动作，可以对评论，用户进行点赞或者踩，对用户，圈子进行关注

同一用户对同一对象的互动操作需限制频率（ 1 分钟内最多 5 次）

#### 9.1 互动操作（点赞/踩/关注）

| 路径                            | 方法   | 入参                                                         | 出参                                                  | 权限           | 表操作                                                       |
| ------------------------------- | ------ | ------------------------------------------------------------ | ----------------------------------------------------- | -------------- | ------------------------------------------------------------ |
| `/interactions`                 | POST   | interact_type（互动类型）、interact_target_type（被互动对象类型）、interact_target（被互动对象ID） | code:200、message:"互动成功"、interactionId（互动ID） | 需登录         | 1. 插入interaction（新建互动记录，若已存在则返回“已互动”）；<br>2. 若为点赞/踩：同步更新post/comment的like_count；<br>3. 若为关注：发送“被关注通知”给被关注用户 |
| `/interactions/{interactionId}` | DELETE | 无                                                           | code:200、message:"取消互动成功"                      | 需登录（本人） | 1. 删除interaction（本人互动记录）；<br>2. 若为点赞/踩：同步减少post/comment的like_count |

#### 9.2 互动记录查询

| 路径                  | 方法 | 入参                                                         | 出参                                                         | 权限   | 表操作                                                       |
| --------------------- | ---- | ------------------------------------------------------------ | ------------------------------------------------------------ | ------ | ------------------------------------------------------------ |
| `/interactions/my`    | GET  | pageCursor（游标分页）、interact_type（可选，互动类型（LIKE=点赞/DISLIKE=踩/FOLLOW=关注））、interact_target_type（可选，被互动对象类型（COMMENT=评论/POST=帖子/USER=用户）） | interactions（本人互动列表，含被互动对象基础信息）、total（总数） | 需登录 | 查询interaction（本人互动记录），关联post/comment/user表获取被互动对象详情 |
| `/interactions/count` | GET  | interact_type（互动类型）、interact_target_type（被互动对象类型）、interact_target（被互动对象ID） | data: {count: 互动总数}                                      | 无     | 查询interaction（指定对象的指定互动总数）                    |

### 10.邀请码接口

此接口定义了邀请码的所有操作，包括用户获取邀请码，管理员批量生成邀请码和废除邀请码

#### 10.1 用户操作 finished

| 路径           | 方法 | 入参 | 出参             | 权限   | 表操作                                             |
| -------------- | ---- | ---- | ---------------- | ------ | -------------------------------------------------- |
| `/invitecode/` | GET  | 无   | 用户的邀请码列表 | 需登录 | 若已生成邀请码，直接返回邀请码，否则生成一个邀请码 |

#### 10.2 管理员操作 finished

| 路径                       | 方法   | 入参                                                         | 出参             | 权限   | 表操作                  |
| -------------------------- | ------ | ------------------------------------------------------------ | ---------------- | ------ | ----------------------- |
| `/invitecode/admin`        | POST   | maxCount（最多使用次数）, generateCount（生成次数）, expireDays（过期时间，单位天数） | 生成的邀请码列表 | 管理员 | 对invite_code表新增项目 |
| `/invitecode/admin/{code}` | DELETE | 无                                                           | code:200         | 管理员 | 设置邀请码是否可用      |

