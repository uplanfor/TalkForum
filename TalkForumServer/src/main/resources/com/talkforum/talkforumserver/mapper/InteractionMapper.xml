<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.talkforum.talkforumserver.mapper.InteractionMapper">
    <!-- 插入或更新用户间互动记录，并更新用户的粉丝数和关注数 -->
    <insert id="makeInteractionWithUser" parameterType="com.talkforum.talkforumserver.common.dto.InteractionRequestDTO">
        <!-- 1. 先获取之前的互动内容 -->
        <selectKey keyProperty="oldInteractContent" resultType="java.lang.Integer" order="BEFORE">
            SELECT COALESCE(
                (SELECT interact_content 
                 FROM interaction 
                 WHERE user_id = #{userId} 
                 AND interact_target_type = 'USER' 
                 AND interact_target = #{interactId}
                 LIMIT 1), 
                0
            )
        </selectKey>
        <!-- 2. 插入或更新互动记录 -->
        INSERT INTO interaction (
            user_id,
            interact_content,
            interact_target_type,
            interact_target,
            interact_date
        ) VALUES (
            #{userId},
            #{interactContent},
            'USER',
            #{interactId},
            NOW()
        ) ON DUPLICATE KEY UPDATE
            interact_content = VALUES(interact_content),
            interact_date = NOW();
        
        <!-- 3. 联动更新被关注用户的粉丝数 -->
        UPDATE user
        SET fans_count = CASE 
            WHEN #{interactContent} = 1 THEN 
                -- 关注，需要查看之前的互动类型
                CASE 
                    WHEN #{oldInteractContent} = 1 THEN fans_count  -- 之前就是关注，现在不变
                    ELSE fans_count + 1  -- 之前未关注或已取消，现在增加粉丝数
                END
            WHEN #{interactContent} = 0 THEN 
                -- 取消关注，需要查看之前的互动类型
                CASE 
                    WHEN #{oldInteractContent} = 1 THEN fans_count - 1  -- 之前是关注，现在取消，减少粉丝数
                    ELSE fans_count  -- 之前未关注，现在不变
                END
            ELSE fans_count  -- 其他值不变
        END
        WHERE id = #{interactId};
        
        <!-- 4. 联动更新当前用户的关注数 -->
        UPDATE user
        SET following_count = CASE 
            WHEN #{interactContent} = 1 THEN 
                -- 关注，需要查看之前的互动类型
                CASE 
                    WHEN #{oldInteractContent} = 1 THEN following_count  -- 之前就是关注，现在不变
                    ELSE following_count + 1  -- 之前未关注或已取消，现在增加关注数
                END
            WHEN #{interactContent} = 0 THEN 
                -- 取消关注，需要查看之前的互动类型
                CASE 
                    WHEN #{oldInteractContent} = 1 THEN following_count - 1  -- 之前是关注，现在取消，减少关注数
                    ELSE following_count  -- 之前未关注，现在不变
                END
            ELSE following_count  -- 其他值不变
        END
        WHERE id = #{userId};
    </insert>

    <!-- 插入或更新对评论的互动记录，并更新评论的点赞数量 -->
    <insert id="makeInteractionWithComment" parameterType="com.talkforum.talkforumserver.common.dto.InteractionRequestDTO">
        <!-- 1. 先获取之前的互动内容 -->
        <selectKey keyProperty="oldInteractContent" resultType="java.lang.Integer" order="BEFORE">
            SELECT COALESCE(
                (SELECT interact_content 
                 FROM interaction 
                 WHERE user_id = #{userId} 
                 AND interact_target_type = 'COMMENT' 
                 AND interact_target = #{interactId}
                 LIMIT 1), 
                0
            )
        </selectKey>
        
        <!-- 2. 插入或更新互动记录，有则覆盖，无则添加 -->
        INSERT INTO interaction (
            user_id,
            interact_content,
            interact_target_type,
            interact_target,
            interact_date
        ) VALUES (
            #{userId},
            #{interactContent},
            'COMMENT',
            #{interactId},
            NOW()
        ) ON DUPLICATE KEY UPDATE
            interact_content = VALUES(interact_content),
            interact_date = NOW();
        
        <!-- 3. 联动更新评论的点赞数量，根据新旧值的差值来更新 -->
        UPDATE comment
        SET like_count = CASE 
            WHEN #{oldInteractContent} = 0 THEN 
                -- 先前无记录或interactContent=0，处理方式同先前无记录
                CASE 
                    WHEN #{interactContent} = 1 THEN like_count + 1  -- 用户点赞
                    WHEN #{interactContent} = -1 THEN like_count - 1  -- 用户踩
                    ELSE like_count  -- 用户传入NONE，什么也不做
                END
            WHEN #{oldInteractContent} = 1 THEN 
                -- 先前有点赞记录
                CASE 
                    WHEN #{interactContent} = 1 THEN like_count  -- 用户再点击点赞，什么也不做
                    WHEN #{interactContent} = 0 THEN like_count - 1  -- 传入NONE，likeCount-=1
                    WHEN #{interactContent} = -1 THEN like_count - 2  -- 传入踩，likeCount-=2
                    ELSE like_count
                END
            WHEN #{oldInteractContent} = -1 THEN 
                -- 先前有踩记录
                CASE 
                    WHEN #{interactContent} = -1 THEN like_count  -- 用户再次点踩，什么也不做
                    WHEN #{interactContent} = 0 THEN like_count + 1  -- 传入NONE，likeCount+=1
                    WHEN #{interactContent} = 1 THEN like_count + 2  -- 用户点赞，likeCount+=2
                    ELSE like_count
                END
            ELSE like_count  -- 其他情况不变
        END
        WHERE id = #{interactId};
    </insert>

    <!-- 插入或更新对帖子的互动记录，并更新帖子的点赞数量 -->
    <insert id="makeInteractionWithPost" parameterType="com.talkforum.talkforumserver.common.dto.InteractionRequestDTO">
        <!-- 1. 先获取之前的互动内容 -->
        <selectKey keyProperty="oldInteractContent" resultType="java.lang.Integer" order="BEFORE">
            SELECT COALESCE(
                (SELECT interact_content 
                 FROM interaction 
                 WHERE user_id = #{userId} 
                 AND interact_target_type = 'POST' 
                 AND interact_target = #{interactId}
                 LIMIT 1), 
                0
            )
        </selectKey>
        
        <!-- 2. 插入或更新互动记录，有则覆盖，无则添加 -->
        INSERT INTO interaction (
            user_id,
            interact_content,
            interact_target_type,
            interact_target,
            interact_date
        ) VALUES (
            #{userId},
            #{interactContent},
            'POST',
            #{interactId},
            NOW()
        ) ON DUPLICATE KEY UPDATE
            interact_content = VALUES(interact_content),
            interact_date = NOW();
        
        <!-- 3. 联动更新帖子的点赞数量，根据新旧值的差值来更新 -->
        UPDATE post
        SET like_count = CASE 
            WHEN #{oldInteractContent} = 0 THEN 
                -- 先前无记录或interactContent=0，处理方式同先前无记录
                CASE 
                    WHEN #{interactContent} = 1 THEN like_count + 1  -- 用户点赞
                    WHEN #{interactContent} = -1 THEN like_count - 1  -- 用户踩
                    ELSE like_count  -- 用户传入NONE，什么也不做
                END
            WHEN #{oldInteractContent} = 1 THEN 
                -- 先前有点赞记录
                CASE 
                    WHEN #{interactContent} = 1 THEN like_count  -- 用户再点击点赞，什么也不做
                    WHEN #{interactContent} = 0 THEN like_count - 1  -- 传入NONE，likeCount-=1
                    WHEN #{interactContent} = -1 THEN like_count - 2  -- 传入踩，likeCount-=2
                    ELSE like_count
                END
            WHEN #{oldInteractContent} = -1 THEN 
                -- 先前有踩记录
                CASE 
                    WHEN #{interactContent} = -1 THEN like_count  -- 用户再次点踩，什么也不做
                    WHEN #{interactContent} = 0 THEN like_count + 1  -- 传入NONE，likeCount+=1
                    WHEN #{interactContent} = 1 THEN like_count + 2  -- 用户点赞，likeCount+=2
                    ELSE like_count
                END
            ELSE like_count  -- 其他情况不变
        END
        WHERE id = #{interactId};
    </insert>
    <!-- 根据interactTargetType、interactTargets和userId查询互动记录，返回与interactTargets一一对应的InteractContent列表，无记录则返回0 -->
    <select id="queryInteractContentByPostOrComment" resultType="java.lang.Integer">
        SELECT COALESCE(i.interact_content, 0) as interact_content
        FROM (
            <foreach collection="interactTargets" item="targetId" separator="UNION ALL" index="index">
                SELECT #{targetId} as target_id, #{index} as sort_index
            </foreach>
        ) t
        LEFT JOIN interaction i ON t.target_id = i.interact_target 
        AND i.interact_target_type = #{interactTargetType}
        AND i.user_id = #{userId}
        ORDER BY t.sort_index
    </select>

    <!-- 根据用户ID查询关注记录 -->
    <select id="queryInteractFollowingByUserId" resultType="java.lang.Long">
        SELECT interact_target
        FROM interaction
        WHERE user_id = #{userId}
        AND interact_target_type = 'USER'
        AND interact_content = 1
    </select>

</mapper>
